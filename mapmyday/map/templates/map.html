{% extends 'base.html' %}

{% block title %}The Map - MapMyDay{% endblock %}

{% block content %}
    {% load static %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="{% static 'css/map.css' %}">
    <div id="search-container">
        <input type="text" id="search-bar" placeholder="Search for an area...">
        <button id="search-button">Search</button>
    </div>
    <div id="map"></div>
    <div id="location-list" class="location-list-container"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const markersLayer = L.layerGroup().addTo(map);

        // detecting user's location
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                map.setView([latitude, longitude], 13);
                fetchNearbyAttractions(latitude, longitude, 5000);
            },
            error => console.error("Error getting user location: ", error),
            { enableHighAccuracy: true }
        );

        // search button functionality
        document.getElementById("search-button").addEventListener("click", function () {
            const query = document.getElementById("search-bar").value.trim();

            if (!query) {
                alert("Please enter an area to search.");
                return;
            }

            // using Nominatim API to search for areas
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        alert("No results found.");
                        return;
                    }

                    const result = data[0];
                    const latitude = parseFloat(result.lat);
                    const longitude = parseFloat(result.lon);

                    // map is set to result location
                    map.setView([latitude, longitude], 15);

                    // calling Overpass API to search for nearby attractions
                    fetchNearbyAttractions(latitude, longitude, 2000);
                })
                .catch(error => console.error("Error with Nominatim API:", error));
        });


        // enter key to search
        document.getElementById("search-bar").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                document.getElementById("search-button").click();
            }
        });

        // function to fetch Overpass data for an area
        function fetchNearbyAttractions(latitude, longitude, radius = 5000) {
            const overpassQuery = `
                [out:json];
                (
                    node["tourism"~"attraction|museum|zoo|viewpoint|theme_park"]
                    (around:${radius}, ${latitude}, ${longitude});
                    node["leisure"~"park|garden|nature_reserve|stadium|swimming_pool"]
                    (around:${radius}, ${latitude}, ${longitude});
                    node["amenity"~"restaurant|pub|bar"]
                    (around:${radius}, ${latitude}, ${longitude});
                    node["historic"~"castle|ruins|monument|memorial"]
                    (around:${radius}, ${latitude}, ${longitude});
                );
                out body;
            `;
        
            fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                body: overpassQuery,
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then((data) => {
                    // clearing previous markers & location list
                    markersLayer.clearLayers();
                    const locationListContainer = document.getElementById("location-list");
                    locationListContainer.innerHTML = "";
        
                    // adding markers to map and updating location list
                    const locations = data.elements.filter(location => location.lat && location.lon && location.tags.name);
                    locations.forEach((location) => {
                        // marker popup fields:
                        const popupContent = `
                            <b>${location.tags.name}</b><br>
                            <strong>Type:</strong> ${location.tags.tourism || location.tags.leisure || location.tags.amenity || location.tags.historic || "Unknown"}<br>
                            <strong>Address:</strong> ${location.tags["addr:full"] || location.tags["addr:street"] || 'N/A'}<br>
                            <strong>Website:</strong> ${location.tags.website ? `<a href="${location.tags.website}" target="_blank">${location.tags.website}</a>` : 'N/A'}<br>
                            <strong>Phone:</strong> ${location.tags.phone || 'N/A'}<br>
                            <strong>Email:</strong> ${location.tags.email || 'N/A'}<br>
                            <strong>Opening Hours:</strong> ${location.tags.opening_hours || 'N/A'}<br>
                        `;
        
                        L.marker([location.lat, location.lon])
                            .addTo(markersLayer)
                            .bindPopup(popupContent);
        
                        // updating location list
                        if (locationListContainer.children.length < 10) {
                            const locationItem = document.createElement("div");
                            locationItem.className = "location-item";
                            locationItem.innerHTML = popupContent;
                            locationItem.addEventListener("click", function () {
                                map.setView([location.lat, location.lon], 17);
                                const mapContainer = document.getElementById("map");
                                if (mapContainer) {
                                    mapContainer.scrollIntoView({ behavior: "smooth", block: "start" });
                                }
                            });
                            
                            locationListContainer.appendChild(locationItem);
                        }
                    });
                })
                .catch(error => console.error("Error with Overpass API:", error));
        }        
    </script>
{% endblock %}
